<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø© | True Draft ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        #initial-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .loader { border: 4px solid #e5e7eb; border-top: 4px solid #000; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dragging { opacity: 0.5; background: #e0e7ff; }
        .drag-over { border: 2px dashed #4f46e5; }
    </style>
</head>
<body>
    <div id="initial-loader"><div class="loader"></div></div>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgxIJYhMQB_2n_CbQ47uhnU8lBE2ji5J8",
            authDomain: "truedraftcrm.firebaseapp.com",
            projectId: "truedraftcrm",
            storageBucket: "truedraftcrm.firebasestorage.app",
            messagingSenderId: "920547055600",
            appId: "1:920547055600:web:c74f7de68ca8ae35852f35"
        };
        try {
            const app = initializeApp(firebaseConfig);
            window.db = getDatabase(app);
            window.auth = getAuth(app);
            window.dbRef = ref;
            window.dbPush = push;
            window.dbSet = set;
            window.dbOnValue = onValue;
            window.dbRemove = remove;
            window.dbUpdate = update;
            window.dbGet = get;
            window.authSignIn = signInWithEmailAndPassword;
            window.authSignOut = signOut;
            window.authListener = onAuthStateChanged;
            document.dispatchEvent(new Event('firebaseReady'));
        } catch (error) {
            console.error("Firebase Init Error:", error);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const Icon = ({ name, size = 16, className = "" }) => <i data-lucide={name} width={size} height={size} className={className}></i>;
        
        const Login = () => { /* Same login component as erp.html can be used here if needed */ return <p>Redirecting to login...</p>; };

        const Header = ({ user }) => (
            <header className="bg-white h-16 border-b flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
                <div className="flex items-center gap-4">
                     <a href="erp.html#home" className="text-gray-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-gray-100 transition">
                        <Icon name="arrow-left" size={18} /> Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    </a>
                </div>
                 <div className="flex items-center gap-4">
                    <div className="text-right">
                        <div className="font-bold">{user.name} ğŸ‘‹</div>
                        <div className="text-xs text-gray-500 font-bold uppercase">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©</div>
                    </div>
                    <button onClick={() => window.authSignOut(window.auth)} title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" className="bg-gray-100 text-gray-800 p-2.5 rounded-lg font-bold flex items-center hover:bg-gray-200 transition">
                        <Icon name="log-out" size={20} />
                    </button>
                </div>
            </header>
        );

        const PostEditor = ({ post, onSave, onCancel }) => {
            const [data, setData] = useState(post || {
                title_ar: '', title_en: '', category_ar: '', category_en: '',
                content_ar: '', content_en: '', imageUrl: '', slug: '', date: new Date().toISOString()
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setData(prev => ({ ...prev, [name]: value }));

                if (name === 'title_ar') {
                    const newSlug = value.trim().toLowerCase()
                        .replace(/\s+/g, '-') // Replace spaces with -
                        .replace(/[^\u0621-\u064A\u0660-\u0669a-z0-9-]/g, '') // Remove special chars except Arabic
                        .replace(/--+/g, '-'); // Replace multiple - with single -
                    setData(prev => ({ ...prev, slug: newSlug }));
                }
            };

            const handleSave = () => {
                if (!data.title_ar || !data.slug || !data.imageUrl) {
                    alert('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¹Ø±Ø¨ÙŠ)ØŒ Ø§Ù„Ø±Ø§Ø¨Ø· (Slug)ØŒ ÙˆØ±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©.');
                    return;
                }
                onSave(data);
            };

            return (
                 <div className="max-w-5xl mx-auto animate-fade-in p-8">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">{post ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„ Ø¬Ø¯ÙŠØ¯'}</h2>
                         <button onClick={onCancel} className="text-gray-600 font-bold flex items-center gap-2"><Icon name="x"/> Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                    <div className="bg-white p-6 rounded-xl border shadow-sm space-y-6">
                        <div className="grid md:grid-cols-2 gap-4">
                            <div><label className="font-bold">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¹Ø±Ø¨ÙŠ)</label><input name="title_ar" value={data.title_ar} onChange={handleChange} className="w-full mt-1 border p-2 rounded"/></div>
                            <div><label className="font-bold">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input name="title_en" value={data.title_en} onChange={handleChange} className="w-full mt-1 border p-2 rounded"/></div>
                        </div>
                        <div className="grid md:grid-cols-2 gap-4">
                            <div><label className="font-bold">Ø§Ù„ØªØµÙ†ÙŠÙ (Ø¹Ø±Ø¨ÙŠ)</label><input name="category_ar" value={data.category_ar} onChange={handleChange} className="w-full mt-1 border p-2 rounded"/></div>
                            <div><label className="font-bold">Ø§Ù„ØªØµÙ†ÙŠÙ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input name="category_en" value={data.category_en} onChange={handleChange} className="w-full mt-1 border p-2 rounded"/></div>
                        </div>
                        <div>
                            <label className="font-bold">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (URL)</label>
                            <input name="imageUrl" value={data.imageUrl} onChange={handleChange} className="w-full mt-1 border p-2 rounded" dir="ltr"/>
                            {data.imageUrl && <img src={data.imageUrl} className="mt-2 h-32 object-cover rounded-lg border"/>}
                        </div>
                        <div>
                            <label className="font-bold">Ø§Ù„Ø±Ø§Ø¨Ø· (Slug)</label>
                            <input name="slug" value={data.slug} onChange={handleChange} className="w-full mt-1 border p-2 rounded bg-gray-50" dir="ltr"/>
                        </div>
                        <div className="grid md:grid-cols-2 gap-4">
                            <div><label className="font-bold">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø¹Ø±Ø¨ÙŠ)</label><textarea name="content_ar" value={data.content_ar} onChange={handleChange} rows="10" className="w-full mt-1 border p-2 rounded"></textarea></div>
                            <div><label className="font-bold">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><textarea name="content_en" value={data.content_en} onChange={handleChange} rows="10" className="w-full mt-1 border p-2 rounded"></textarea></div>
                        </div>
                        <div className="flex justify-end gap-3 pt-4 border-t">
                            <button onClick={onCancel} className="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                            <button onClick={handleSave} className="bg-black text-white px-6 py-2 rounded-lg font-bold">Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ù„</button>
                        </div>
                    </div>
                </div>
            );
        };

        const PostList = ({ posts, onEdit, onAddNew, onDelete, onReorder }) => {
            const dragItem = useRef();
            const dragOverItem = useRef();

            const handleDragStart = (e, position) => {
                dragItem.current = position;
                e.target.classList.add('dragging');
            };
            
            const handleDragEnter = (e, position) => {
                dragOverItem.current = position;
                const listItems = Array.from(e.target.parentNode.children);
                listItems.forEach(item => item.classList.remove('drag-over'));
                e.target.classList.add('drag-over');
            };

            const handleDrop = (e) => {
                const copyListItems = [...posts];
                const dragItemContent = copyListItems[dragItem.current];
                copyListItems.splice(dragItem.current, 1);
                copyListItems.splice(dragOverItem.current, 0, dragItemContent);
                dragItem.current = null;
                dragOverItem.current = null;
                onReorder(copyListItems);
                e.target.parentNode.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                e.target.parentNode.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            };
            
            return (
                <div className="max-w-5xl mx-auto animate-fade-in p-8">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold">Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©</h2>
                        <button onClick={onAddNew} className="bg-black text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2"><Icon name="plus"/> Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„</button>
                    </div>
                     <p className="text-sm text-gray-500 mb-4">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨Ù‡Ø§.</p>
                    <div className="bg-white rounded-xl border shadow-sm space-y-2 p-2">
                        {posts.map((post, index) => (
                            <div 
                                key={post.id} 
                                className="flex items-center gap-4 p-2 border-b last:border-0 rounded-lg cursor-grab hover:bg-gray-50"
                                onDragStart={(e) => handleDragStart(e, index)}
                                onDragEnter={(e) => handleDragEnter(e, index)}
                                onDragEnd={handleDrop}
                                onDragOver={(e) => e.preventDefault()}
                                draggable
                            >
                                <Icon name="grip-vertical" className="text-gray-400"/>
                                <img src={post.imageUrl} className="w-16 h-12 object-cover rounded"/>
                                <div className="flex-1 font-bold">{post.title_ar}</div>
                                <div className="text-xs text-gray-500">{new Date(post.date).toLocaleDateString('en-GB')}</div>
                                <div className="flex gap-2">
                                    <button onClick={() => onEdit(post)} className="text-blue-500 p-2 hover:bg-blue-50 rounded"><Icon name="edit-2"/></button>
                                    <button onClick={() => onDelete(post.id)} className="text-red-500 p-2 hover:bg-red-50 rounded"><Icon name="trash-2"/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const BlogManager = ({ user }) => {
            const [posts, setPosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [editingPost, setEditingPost] = useState(null); // null for list, object for editor
            const [view, setView] = useState('list'); // 'list' or 'editor'

            useEffect(() => {
                const postsRef = window.dbRef(window.db, 'blogPosts');
                return window.dbOnValue(postsRef, (snapshot) => {
                    const data = snapshot.val();
                    const postList = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                    postList.sort((a,b) => (a.order || 999) - (b.order || 999) || new Date(b.date) - new Date(a.date));
                    setPosts(postList);
                    setLoading(false);
                });
            }, []);

            const handleSavePost = (postData) => {
                if (postData.id) { // Editing
                    const { id, ...dataToSave } = postData;
                    window.dbUpdate(window.dbRef(window.db, `blogPosts/${id}`), dataToSave);
                } else { // Adding new
                    const newPostRef = window.dbPush(window.dbRef(window.db, 'blogPosts'));
                    const newOrder = posts.length > 0 ? Math.max(...posts.map(p => p.order || 0)) + 1 : 0;
                    window.dbSet(newPostRef, {...postData, order: newOrder});
                }
                setView('list');
                setEditingPost(null);
            };
            
            const handleDelete = (id) => {
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) {
                    window.dbRemove(window.dbRef(window.db, `blogPosts/${id}`));
                }
            };
            
             const handleReorder = (reorderedPosts) => {
                const updates = {};
                reorderedPosts.forEach((post, index) => {
                    updates[`/blogPosts/${post.id}/order`] = index;
                });
                window.dbUpdate(window.dbRef(window.db), updates);
                // No need to setPosts here as onValue listener will do it
            };

            const showEditor = (post = null) => {
                setEditingPost(post);
                setView('editor');
            };

            const showList = () => {
                setEditingPost(null);
                setView('list');
            };
            
            useEffect(() => { lucide.createIcons(); }, [view, posts, loading]);

            if (loading) return <div id="initial-loader"><div className="loader"></div></div>;

            return (
                 <div className="flex flex-col min-h-screen bg-slate-50">
                    <Header user={user} />
                    <main className="flex-1">
                        {view === 'list' && (
                            <PostList 
                                posts={posts} 
                                onEdit={showEditor} 
                                onAddNew={() => showEditor(null)}
                                onDelete={handleDelete}
                                onReorder={handleReorder}
                            />
                        )}
                        {view === 'editor' && (
                            <PostEditor 
                                post={editingPost} 
                                onSave={handleSavePost} 
                                onCancel={showList} 
                            />
                        )}
                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const initAuth = () => {
                    document.getElementById('initial-loader').style.display = 'none';
                    return window.authListener(window.auth, (u) => {
                        if (u) {
                            // For simplicity, assuming any logged in user can edit blog for now.
                            // In a real app, you'd fetch user roles from DB.
                            setUser({ name: u.email.split('@')[0], email: u.email });
                        } else {
                            // Redirect to main ERP login if not authenticated
                            window.location.href = 'erp.html';
                        }
                        setLoading(false);
                    });
                };
                 document.addEventListener('firebaseReady', initAuth, { once: true });
            }, []);

            if (loading) return null;
            if (!user) return <Login />;

            return <BlogManager user={user} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
