<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø© | True Draft ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; color: #1a202c; }
        #initial-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 9999; display: flex; flex-direction:column; align-items: center; justify-content: center; }
        .loader { border: 4px solid #e2e8f0; border-top: 4px solid #050505; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; } 
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dragging { opacity: 0.5; background: #eef2ff; }
        .drag-over { border: 2px dashed #4f46e5; }
    </style>
</head>
<body>
    <div id="initial-loader">
        <div class="loader"></div>
        <p class="mt-4 font-bold text-gray-600">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...</p>
    </div>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        const firebaseConfig = { apiKey: "AIzaSyAgxIJYhMQB_2n_CbQ47uhnU8lBE2ji5J8", authDomain: "truedraftcrm.firebaseapp.com", databaseURL: "https://truedraftcrm-default-rtdb.firebaseio.com", projectId: "truedraftcrm", storageBucket: "truedraftcrm.firebasestorage.app", messagingSenderId: "920547055600", appId: "1:920547055600:web:c74f7de68ca8ae35852f35" };
        try {
            const app = initializeApp(firebaseConfig);
            window.db = getDatabase(app);
            window.auth = getAuth(app);
            window.dbRef = ref; window.dbPush = push; window.dbSet = set; window.dbOnValue = onValue;
            window.dbRemove = remove; window.dbUpdate = update; window.dbGet = get;
            window.authListener = onAuthStateChanged;
            window.firebaseIsReady = true;
            document.dispatchEvent(new Event('firebaseReady'));
        } catch (error) { console.error("Firebase Init Error:", error); }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef, memo } = React;

        const Icons = { Plus: 'plus', X: 'x', ArrowLeft: 'arrow-left', Trash2: 'trash-2', Edit2: 'edit-2', LogOut: 'log-out', GripVertical: 'grip-vertical', LayoutDashboard: 'layout-dashboard' };
        const Icon = memo(({ name, size = 16, className = "" }) => { useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [name]); return <i data-lucide={Icons[name]} width={size} height={size} className={className}></i>; });
        
        const Header = memo(({ user }) => (
             <header className="bg-white/80 backdrop-blur-lg h-20 border-b flex items-center justify-between px-6 shrink-0 z-10 sticky top-0">
                <div className="flex items-center gap-4">
                     <a href="erp.html" className="text-gray-800 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-gray-100 transition">
                        <Icon name="LayoutDashboard" size={18} /> Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
                    </a>
                </div>
                 <div className="flex items-center gap-4">
                    <div className="text-right">
                        <div className="font-bold text-gray-800">{user.name} ğŸ‘‹</div>
                        <div className="text-xs text-gray-500 font-bold uppercase">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©</div>
                    </div>
                    <button onClick={() => window.auth.signOut()} title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" className="bg-red-50 text-red-600 p-3 rounded-lg font-bold flex items-center hover:bg-red-100 transition">
                        <Icon name="LogOut" size={20} />
                    </button>
                </div>
            </header>
        ));

        const PostEditor = memo(({ post, onSave, onCancel }) => {
            const [data, setData] = useState(post || { title_ar: '', title_en: '', category_ar: '', category_en: '', content_ar: '', content_en: '', imageUrl: '', slug: '', date: new Date().toISOString() });
            const handleChange = (e) => {
                const { name, value } = e.target;
                setData(prev => ({ ...prev, [name]: value }));
                if (name === 'title_ar') { setData(prev => ({ ...prev, slug: value.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^\u0621-\u064A\u0660-\u0669a-z0-9-]/g, '').replace(/--+/g, '-') })); }
            };
            const handleSave = () => { if (!data.title_ar || !data.slug || !data.imageUrl) { alert('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¹Ø±Ø¨ÙŠ)ØŒ Ø§Ù„Ø±Ø§Ø¨Ø· (Slug)ØŒ ÙˆØ±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©.'); return; } onSave(data); };

            return (
                 <div className="max-w-5xl mx-auto animate-fade-in p-6 md:p-8">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold">{post ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„ Ø¬Ø¯ÙŠØ¯'}</h2>
                         <button onClick={onCancel} className="text-gray-600 font-bold flex items-center gap-2 hover:text-black transition"><Icon name="X"/> Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                    <div className="bg-white p-6 rounded-xl border shadow-sm space-y-6">
                        <div className="grid md:grid-cols-2 gap-4">
                            <div><label className="font-bold text-sm mb-1 block">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¹Ø±Ø¨ÙŠ)</label><input name="title_ar" value={data.title_ar} onChange={handleChange} className="w-full border p-2 rounded bg-white"/></div>
                            <div><label className="font-bold text-sm mb-1 block">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input name="title_en" value={data.title_en} onChange={handleChange} className="w-full border p-2 rounded bg-white"/></div>
                        </div>
                        <div className="grid md:grid-cols-2 gap-4">
                            <div><label className="font-bold text-sm mb-1 block">Ø§Ù„ØªØµÙ†ÙŠÙ (Ø¹Ø±Ø¨ÙŠ)</label><input name="category_ar" value={data.category_ar} onChange={handleChange} className="w-full border p-2 rounded bg-white"/></div>
                            <div><label className="font-bold text-sm mb-1 block">Ø§Ù„ØªØµÙ†ÙŠÙ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><input name="category_en" value={data.category_en} onChange={handleChange} className="w-full border p-2 rounded bg-white"/></div>
                        </div>
                        <div>
                            <label className="font-bold text-sm mb-1 block">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (URL)</label>
                            <input name="imageUrl" value={data.imageUrl} onChange={handleChange} className="w-full border p-2 rounded bg-white" dir="ltr"/>
                            {data.imageUrl && <img src={data.imageUrl} className="mt-2 h-32 object-cover rounded-lg border"/>}
                        </div>
                        <div>
                            <label className="font-bold text-sm mb-1 block">Ø§Ù„Ø±Ø§Ø¨Ø· (Slug)</label>
                            <input name="slug" value={data.slug} onChange={handleChange} className="w-full border p-2 rounded bg-gray-50" dir="ltr"/>
                        </div>
                        <div className="grid md:grid-cols-2 gap-4">
                            <div><label className="font-bold text-sm mb-1 block">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø¹Ø±Ø¨ÙŠ)</label><textarea name="content_ar" value={data.content_ar} onChange={handleChange} rows="10" className="w-full border p-2 rounded bg-white"></textarea></div>
                            <div><label className="font-bold text-sm mb-1 block">Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)</label><textarea name="content_en" value={data.content_en} onChange={handleChange} rows="10" className="w-full border p-2 rounded bg-white"></textarea></div>
                        </div>
                        <div className="flex justify-end gap-3 pt-4 border-t">
                            <button onClick={onCancel} className="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg font-bold hover:bg-gray-300 transition">Ø¥Ù„ØºØ§Ø¡</button>
                            <button onClick={handleSave} className="bg-black text-white px-6 py-2 rounded-lg font-bold hover:bg-gray-800 transition">Ø­ÙØ¸ Ø§Ù„Ù…Ù‚Ø§Ù„</button>
                        </div>
                    </div>
                </div>
            );
        });

        const PostList = memo(({ posts, onEdit, onAddNew, onDelete, onReorder }) => {
            const dragItem = useRef(); const dragOverItem = useRef();
            const handleDragStart = (e, i) => { dragItem.current = i; e.target.classList.add('dragging'); };
            const handleDragEnter = (e, i) => { dragOverItem.current = i; Array.from(e.target.parentNode.children).forEach(c => c.classList.remove('drag-over')); e.target.classList.add('drag-over'); };
            const handleDrop = (e) => {
                const list = [...posts]; const dragItemContent = list[dragItem.current];
                list.splice(dragItem.current, 1); list.splice(dragOverItem.current, 0, dragItemContent);
                dragItem.current = null; dragOverItem.current = null;
                onReorder(list);
                e.target.parentNode.querySelectorAll('.dragging, .drag-over').forEach(el => el.classList.remove('dragging', 'drag-over'));
            };
            
            return (
                <div className="max-w-5xl mx-auto animate-fade-in p-6 md:p-8">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-3xl font-bold">Ù…Ù‚Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©</h2>
                        <button onClick={onAddNew} className="bg-black text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-gray-800 transition"><Icon name="Plus"/> Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§Ù„</button>
                    </div>
                     <p className="text-sm text-gray-500 mb-4">Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨Ù‡Ø§.</p>
                    <div className="bg-white rounded-xl border shadow-sm">
                        {posts.map((post, index) => (
                            <div key={post.id} className="flex items-center gap-4 p-3 border-b last:border-0 cursor-grab hover:bg-gray-50" onDragStart={(e)=>handleDragStart(e,index)} onDragEnter={(e)=>handleDragEnter(e,index)} onDragEnd={handleDrop} onDragOver={(e)=>e.preventDefault()} draggable>
                                <Icon name="GripVertical" className="text-gray-400"/>
                                <img src={post.imageUrl} className="w-20 h-14 object-cover rounded-md"/>
                                <div className="flex-1 font-bold text-gray-800">{post.title_ar}</div>
                                <div className="text-xs text-gray-500">{new Date(post.date).toLocaleDateString('en-GB')}</div>
                                <div className="flex gap-1">
                                    <button onClick={() => onEdit(post)} className="text-gray-500 p-2 hover:bg-blue-50 hover:text-blue-600 rounded-md transition"><Icon name="Edit2"/></button>
                                    <button onClick={() => onDelete(post.id)} className="text-gray-500 p-2 hover:bg-red-50 hover:text-red-600 rounded-md transition"><Icon name="Trash2"/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        });
        
        const BlogManager = ({ user }) => {
            const [posts, setPosts] = useState([]);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('list');
            const [editingPost, setEditingPost] = useState(null);

            useEffect(() => {
                const postsRef = window.dbRef(window.db, 'blogPosts');
                return window.dbOnValue(postsRef, (snapshot) => {
                    const data = snapshot.val();
                    const list = data ? Object.keys(data).map(key => ({ id: key, ...data[key] })) : [];
                    list.sort((a,b) => (a.order || 999) - (b.order || 999) || new Date(b.date) - new Date(a.date));
                    setPosts(list); setLoading(false);
                });
            }, []);

            const handleSavePost = (data) => {
                if (data.id) {
                    const { id, ...saveData } = data;
                    window.dbUpdate(window.dbRef(window.db, `blogPosts/${id}`), saveData);
                } else {
                    const newRef = window.dbPush(window.dbRef(window.db, 'blogPosts'));
                    window.dbSet(newRef, {...data, order: posts.length });
                }
                setView('list'); setEditingPost(null);
            };
            const handleDelete = (id) => { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù„ØŸ')) window.dbRemove(window.dbRef(window.db, `blogPosts/${id}`)); };
            const handleReorder = (reordered) => { const updates = {}; reordered.forEach((p, i) => { updates[`/blogPosts/${p.id}/order`] = i; }); window.dbUpdate(window.dbRef(window.db), updates); };

            if (loading) return null;

            return (
                 <div className="flex flex-col min-h-screen">
                    <Header user={user} />
                    <main className="flex-1">
                        {view === 'list' ? 
                            <PostList posts={posts} onEdit={(p)=>{setEditingPost(p); setView('editor');}} onAddNew={()=>{setEditingPost(null); setView('editor');}} onDelete={handleDelete} onReorder={handleReorder}/> : 
                            <PostEditor post={editingPost} onSave={handleSavePost} onCancel={()=>{setView('list'); setEditingPost(null);}}/>
                        }
                    </main>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                const initAuth = () => {
                    window.authListener(window.auth, async (u) => {
                        if (u) {
                            const userRef = window.dbRef(window.db, `users/${u.uid}`);
                            const snapshot = await window.dbGet(userRef);
                            let currentUser = snapshot.exists() ? { id: u.uid, ...snapshot.val() } : null;
                            if (u.email === "al2we09@gmail.com") currentUser = { id: 'admin', name: 'Ali Saleh', email: u.email, role: 'admin' };
                            
                            const impersonatedUserEmail = sessionStorage.getItem('impersonatedUserEmail');
                            if(impersonatedUserEmail) {
                                const userListSnap = await window.dbGet(window.dbRef(window.db, 'users'));
                                const userList = userListSnap.val() || {};
                                const targetEntry = Object.entries(userList).find(([, val]) => val.email === impersonatedUserEmail);
                                if(targetEntry) currentUser = { id: targetEntry[0], ...targetEntry[1] };
                            }

                            if (currentUser && (currentUser.role === 'admin' || (currentUser.permissions && currentUser.permissions.blog === 'supervisor'))) {
                                setUser(currentUser);
                            } else {
                                alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©.'); window.location.href = 'erp.html';
                            }
                        } else {
                            window.location.href = 'erp.html';
                        }
                        setLoading(false);
                        const loader = document.getElementById('initial-loader');
                        if (loader) loader.style.display = 'none';
                    });
                };
                
                if (window.firebaseIsReady) {
                    initAuth();
                } else {
                    document.addEventListener('firebaseReady', initAuth, { once: true });
                }
            }, []);

            if (loading || !user) return null;
            return <BlogManager user={user} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
