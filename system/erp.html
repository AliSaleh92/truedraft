<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>True Draft ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #ffffff; touch-action: manipulation; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #999; }
        
        #initial-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        .loader { border: 4px solid #e5e7eb; border-top: 4px solid #000; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .date-en { font-family: sans-serif; direction: ltr; display: inline-block; }
    </style>
</head>
<body>
    <div id="initial-loader">
        <div class="loader"></div>
        <p class="mt-4 text-gray-500 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
    </div>

    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgxIJYhMQB_2n_CbQ47uhnU8lBE2ji5J8",
            authDomain: "truedraftcrm.firebaseapp.com",
            projectId: "truedraftcrm",
            storageBucket: "truedraftcrm.firebasestorage.app",
            messagingSenderId: "920547055600",
            appId: "1:920547055600:web:c74f7de68ca8ae35852f35"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const auth = getAuth(app);

            window.db = db;
            window.auth = auth;
            window.dbRef = ref;
            window.dbPush = push;
            window.dbSet = set;
            window.dbOnValue = onValue;
            window.dbRemove = remove;
            window.dbUpdate = update;
            window.dbGet = get;
            window.authSignIn = signInWithEmailAndPassword;
            window.authSignOut = signOut;
            window.authListener = onAuthStateChanged;
            
            window.firebaseReady = true;
        } catch (error) {
            console.error("Firebase Init Error:", error);
            document.getElementById('initial-loader').innerHTML = '<p style="color:red">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const Icons = {
            Users: "users-2", Briefcase: "briefcase", Clock: "clock", Grid: "layout-grid",
            LogOut: "log-out", UserCog: "user-cog", Plus: "plus", X: "x", ArrowLeft: "arrow-left",
            Trash2: "trash-2", Edit: "edit", KeyRound: "key-round", FileText: "file-text",
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if(window.lucide) window.lucide.createIcons(); }, [name]);
            return <i data-lucide={Icons[name]} width={size} height={size} className={className}></i>;
        };
        
        const Login = () => {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [err, setErr] = useState('');
            const [loading, setLoading] = useState(false);

            const handleLogin = (e) => {
                e.preventDefault();
                setLoading(true);
                setErr('');
                window.authSignIn(window.auth, email, pass)
                    .then(() => {
                        window.location.hash = '#home';
                    })
                    .catch(() => {
                        setLoading(false);
                        setErr('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                    });
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-[#101414]">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
                        <img src="../images/logo.png" alt="True Draft" className="h-20 mx-auto mb-6 object-contain" onError={(e) => e.target.style.display='none'} />
                        <h1 className="text-2xl font-bold mb-2">Ù†Ø¸Ø§Ù… True Draft</h1>
                        <p className="text-gray-500 mb-8">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
                        {err && <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm">{err}</div>}
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" required placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" className="w-full p-3 border rounded-lg outline-none focus:border-black" value={email} onChange={e=>setEmail(e.target.value)} />
                            <input type="password" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" className="w-full p-3 border rounded-lg outline-none focus:border-black" value={pass} onChange={e=>setPass(e.target.value)} />
                            <button disabled={loading} className="w-full bg-black text-white p-3 rounded-lg font-bold hover:bg-gray-800 transition disabled:opacity-50">
                                {loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...' : 'Ø¯Ø®ÙˆÙ„'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const MODULES = [
            { key: 'crm', name: 'Ù†Ø¸Ø§Ù… CRM', icon: 'Grid' },
            { key: 'blog', name: 'Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©', icon: 'FileText' },
        ];
        const PERMISSIONS = [
            { key: 'supervisor', label: 'Ù…Ø´Ø±Ù' },
            { key: 'employee', label: 'Ù…ÙˆØ¸Ù' },
            { key: 'none', label: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }
        ];

        const AddUserModal = ({ onClose, onSave }) => {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [uid, setUid] = useState('');

            const handleSave = () => {
                if (!name || !email || !uid) {
                    alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„.');
                    return;
                }
                onSave({ name, email, uid });
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h3>
                            <button onClick={onClose}><Icon name="X" /></button>
                        </div>
                        <div className="space-y-4">
                            <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 text-xs p-3 rounded-lg">
                                ØªÙ†Ø¨ÙŠÙ‡: ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù„Ù„Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹ ÙÙŠ ØµÙØ­Ø© Authentication Ø«Ù… Ù†Ø³Ø® Ø§Ù„Ù€ UID ÙˆÙ„ØµÙ‚Ù‡ Ù‡Ù†Ø§.
                            </div>
                            <div><label className="text-sm font-bold mb-1 block">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label><input className="w-full border p-2 rounded" value={name} onChange={e=>setName(e.target.value)} /></div>
                            <div><label className="text-sm font-bold mb-1 block">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" className="w-full border p-2 rounded date-en" value={email} onChange={e=>setEmail(e.target.value)} /></div>
                            <div><label className="text-sm font-bold mb-1 block">UID</label><input className="w-full border p-2 rounded date-en" value={uid} onChange={e=>setUid(e.target.value)} /></div>
                            <button onClick={handleSave} className="w-full bg-black text-white py-3 rounded-lg font-bold mt-4 hover:bg-gray-800">Ø­ÙØ¸ ÙˆÙ…ØªØ§Ø¨Ø¹Ø©</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const EditPermissionsModal = ({ user, onClose, onSave }) => {
            const [permissions, setPermissions] = useState(user.permissions || {});

            const handlePermissionChange = (moduleKey, permissionKey) => {
                setPermissions(prev => ({...prev, [moduleKey]: permissionKey }));
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center mb-2">
                            <div>
                                <h3 className="text-xl font-bold">ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª: {user.name}</h3>
                                <p className="text-sm text-gray-500 date-en">{user.email}</p>
                            </div>
                            <button onClick={onClose}><Icon name="X" /></button>
                        </div>
                        <div className="flex-grow overflow-y-auto pr-2 -mr-2 mt-4">
                            <div className="space-y-4">
                                {MODULES.map(module => (
                                    <div key={module.key} className="p-4 border rounded-xl">
                                        <div className="font-bold flex items-center gap-2 mb-3"><Icon name={module.icon} size={18} /> {module.name}</div>
                                        <div className="flex items-center gap-2">
                                            {PERMISSIONS.map(perm => (
                                                <button 
                                                    key={perm.key}
                                                    onClick={() => handlePermissionChange(module.key, perm.key)}
                                                    className={`px-4 py-2 text-sm rounded-lg border-2 font-bold transition ${permissions[module.key] === perm.key ? 'bg-black text-white border-black' : 'bg-gray-100 border-gray-100 hover:border-gray-300'}`}
                                                >
                                                    {perm.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="mt-6 pt-4 border-t flex gap-2">
                            <button onClick={() => onSave(user.id, permissions)} className="flex-1 bg-black text-white py-3 rounded-lg font-bold hover:bg-gray-800">Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</button>
                            <button onClick={onClose} className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-bold hover:bg-gray-300">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                </div>
            );
        };

        const UserManagement = ({ users, onAddUser, onUpdatePermissions }) => {
            const [isAddModalOpen, setAddModalOpen] = useState(false);
            const [editingUser, setEditingUser] = useState(null);

            const handleSaveUser = (data) => {
                onAddUser(data);
                setAddModalOpen(false);
            };

            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2>
                        <button onClick={() => setAddModalOpen(true)} className="bg-black text-white px-4 py-2 rounded-lg flex items-center gap-2 font-bold hover:bg-gray-800">
                            <Icon name="Plus" size={18} /> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>

                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-right">
                                <thead className="bg-gray-50/50 text-gray-500 font-bold">
                                    <tr>
                                        <th className="p-4">Ø§Ù„Ø§Ø³Ù…</th>
                                        <th className="p-4">Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                                        <th className="p-4 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {users.map(u => (
                                        <tr key={u.id}>
                                            <td className="p-4 font-bold">{u.name}</td>
                                            <td className="p-4 text-gray-500 date-en">{u.email}</td>
                                            <td className="p-4">
                                                <div className="flex justify-center items-center gap-2">
                                                    <button onClick={() => setEditingUser(u)} className="px-3 py-1.5 text-sm rounded-md bg-gray-100 hover:bg-gray-200 font-bold flex items-center gap-1.5">
                                                        <Icon name="Edit" size={14}/> ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                                                    </button>
                                                    <button disabled className="px-3 py-1.5 text-sm rounded-md bg-gray-100 text-gray-400 font-bold flex items-center gap-1.5 cursor-not-allowed">
                                                        <Icon name="KeyRound" size={14}/> Ø¯Ø®ÙˆÙ„ ÙƒÙ€
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {isAddModalOpen && <AddUserModal onClose={() => setAddModalOpen(false)} onSave={handleSaveUser} />}
                    {editingUser && <EditPermissionsModal user={editingUser} onClose={() => setEditingUser(null)} onSave={onUpdatePermissions} />}
                </div>
            );
        };
        
        const Dashboard = () => {
            const Card = ({ title, desc, icon, href }) => (
                <a href={href} className="bg-white p-8 rounded-2xl shadow-sm border text-center hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center group">
                    <div className="p-4 rounded-xl inline-block mb-5 bg-gray-100 group-hover:bg-black transition-colors">
                        <Icon name={icon} className="text-gray-800 group-hover:text-white transition-colors" size={32} />
                    </div>
                    <h3 className="text-2xl font-bold text-gray-800">{title}</h3>
                    <p className="text-gray-500 mt-2 text-sm flex-grow">{desc}</p>
                </a>
            );

            return (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-8 animate-fade-in max-w-4xl mx-auto mt-8">
                    <Card title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡" desc="Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø§Ù„ØµÙÙ‚Ø§ØªØŒ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª" icon="Grid" href="crm.html" />
                    <Card title="Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" desc="Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¥Ù†Ø´Ø§Ø¡ Ù…Ù‚Ø§Ù„Ø§Øª Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ø§Ù…" icon="FileText" href="../blog.html" />
                </div>
            );
        };

        const Header = ({ user, route }) => {
            return (
                <header className="bg-white h-20 border-b flex items-center justify-between px-6 shrink-0 z-10">
                    <div className="flex items-center gap-4">
                        {route !== '#home' ?
                            <a href="#home" className="text-gray-600 px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-gray-100 transition">
                                <Icon name="ArrowLeft" size={18} /> Ø±Ø¬ÙˆØ¹
                            </a>
                        :
                            <a href="#home" className="block">
                                <img src="../images/logo.png" alt="True Draft" className="h-10 object-contain"/>
                            </a>
                        }
                    </div>
                    <div className="flex items-center gap-4">
                        <div className="text-right">
                            <div className="font-bold flex items-center gap-2 justify-end">
                                <span className="text-2xl">ğŸ‘‹</span> Ù…Ø±Ø­Ø¨Ø§Ù‹, {user.name}
                            </div>
                            <div className="text-xs text-gray-500 font-bold uppercase tracking-wider text-right">
                                {user.role === 'admin' ? 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…' : 'Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†'}
                            </div>
                        </div>
                        <div className="bg-gray-800 text-white w-12 h-12 rounded-lg flex items-center justify-center font-bold text-xl shadow-inner">
                            TD
                        </div>
                        {user.role === 'admin' &&
                            <a href="#users" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†" className={`p-3 rounded-lg font-bold flex items-center transition ${route === '#users' ? 'bg-black text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`}>
                                <Icon name="UserCog" size={20} />
                            </a>
                        }
                        <button onClick={() => window.authSignOut(window.auth)} title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" className="bg-gray-100 text-gray-800 p-3 rounded-lg font-bold flex items-center hover:bg-gray-200 transition">
                            <Icon name="LogOut" size={20} />
                        </button>
                    </div>
                </header>
            );
        };

        const ADMIN_EMAIL = "al2we09@gmail.com";
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [route, setRoute] = useState(window.location.hash || '#home');
            const [users, setUsers] = useState([]);

            useEffect(() => {
                const handleHashChange = () => setRoute(window.location.hash || '#home');
                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange);
            }, []);

            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.firebaseReady) {
                        clearInterval(interval);
                        const loader = document.getElementById('initial-loader');
                        if (loader) {
                           loader.style.display = 'none';
                        }

                        window.authListener(window.auth, (u) => {
                            if (u) {
                                const usersRef = window.dbRef(window.db, 'users');
                                window.dbOnValue(usersRef, (snap) => {
                                    const val = snap.val();
                                    const userList = val ? Object.keys(val).map(k => ({ id: k, ...val[k] })) : [];
                                    setUsers(userList);

                                    let currentUser = userList.find(x => x.email === u.email);
                                    if (u.email === ADMIN_EMAIL) {
                                        currentUser = { id: 'admin', name: 'Ø§Ù„Ù…Ù„Ùƒ', email: u.email, role: 'admin' };
                                    }

                                    if (currentUser) {
                                        setUser(currentUser);
                                    } else {
                                        setUser({ name: u.email.split('@')[0], email: u.email, role: 'employee' }); // Fallback
                                    }
                                    setLoading(false);
                                });
                            } else {
                                setUser(null);
                                setLoading(false);
                                if(window.location.hash) window.location.hash = '';
                            }
                        });
                    }
                }, 100);
                return () => clearInterval(interval);
            }, []);

            const addUser = (userData) => {
                 const defaultPermissions = MODULES.reduce((acc, module) => ({...acc, [module.key]: 'employee'}), {});
                 const newRef = window.dbRef(window.db, `users/${userData.uid}`);
                 window.dbSet(newRef, { 
                     name: userData.name, 
                     email: userData.email, 
                     uid: userData.uid, 
                     permissions: defaultPermissions 
                 });
                 alert('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­.');
            };

            const updatePermissions = (userId, permissions) => {
                window.dbUpdate(window.dbRef(window.db, `users/${userId}/permissions`), permissions);
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.');
            };

            const renderPage = () => {
                switch(route) {
                    case '#home': return <Dashboard />;
                    case '#users': return user.role === 'admin' ? <UserManagement users={users} onAddUser={addUser} onUpdatePermissions={updatePermissions}/> : <p>Access Denied</p>;
                    default: return <Dashboard />;
                }
            };
            
            if (loading) return null;
            if (!user) return <Login />;

            return (
                <div className="flex flex-col min-h-screen">
                    <Header user={user} route={route} />
                    <main className="flex-1 p-6 md:p-8">
                        {renderPage()}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
